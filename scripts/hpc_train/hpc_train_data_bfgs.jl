using PowerSimulationNODE
using PowerSimulationsDynamicsSurrogates
const PSIDS = PowerSimulationsDynamicsSurrogates
include(joinpath(@__DIR__, "utils.jl"))
if Sys.iswindows() || Sys.isapple()
    const SCRATCH_PATH = joinpath(pwd(), "..")
else
    const SCRATCH_PATH = "/scratch/alpine/mabo4366"
end
train_folder = "exp_data_bfgs"    #The name of the folder where everything related to the group of trainings will be stored (inputs, outputs, systems, logging, etc.)
system_name = "36Bus_CR"               #The specific system from the "systems" folder to use. Will be copied over to the train_folder to make it self-contained.
project_folder = "PowerSystemNODEs"

#= starting_file = joinpath("transfers", "exp_03_14_23_data_random", "input_data", "train_039.json")
p_starting = TrainParams(starting_file)
path_to_output = joinpath(p_starting.output_data_path, p_starting.train_id)
output_dict =
JSON3.read(read(joinpath(path_to_output, "high_level_outputs")), Dict{String, Any})
df_predictions = PowerSimulationNODE.read_arrow_file_to_dataframe(joinpath(path_to_output, "predictions"))
chosen_iteration_index = indexin(output_dict["chosen_iteration"], output_dict["recorded_iterations"])[1]
θ = df_predictions[chosen_iteration_index, "parameters"][1]     
 =#

_copy_full_system_to_train_directory(
    SCRATCH_PATH,
    project_folder,
    train_folder,
    system_name,
)

base_option = TrainParams(
    train_id = "BASE",
    surrogate_buses = vcat(21:29, 31:39),
    train_data = (
        id = "1",
        operating_points = repeat(
            [
                RandomOperatingPointXiao(
                    generator_voltage_range = (0.94, 1.06),
                    generator_power_range = (0.0, 1.0),
                    load_multiplier_range = (0.5, 1.5),
                ),
            ],
            10,
        ),
        perturbations = repeat(
            [[PSIDS.RandomLoadChange(time = 1.0, load_multiplier_range = (0.0, 2.0))]],
            10,
        ),
        params = PSIDS.GenerateDataParams(
            solver = "Rodas5",
            solver_tols = (reltol = 1e-3, abstol = 1e-6),
            tspan = (0.0, 10.0),
            tstops = 0.0:0.1:10.0,
            tsave = 0.0:0.1:10.0,
            formulation = "MassMatrix",
            all_branches_dynamic = false,
            all_lines_dynamic = false,
            seed = 11,
        ),
        system = "full",
    ),
    validation_data = (
        id = "1",
        operating_points = repeat(
            [
                RandomOperatingPointXiao(
                    generator_voltage_range = (0.94, 1.06),
                    generator_power_range = (0.0, 1.0),
                    load_multiplier_range = (0.5, 1.5),
                ),
            ],
            5,
        ),
        perturbations = repeat(
            [[PSIDS.RandomLoadChange(time = 1.0, load_multiplier_range = (0.0, 2.0))]],
            4,
        ),
        params = PSIDS.GenerateDataParams(
            solver = "Rodas5",
            solver_tols = (reltol = 1e-3, abstol = 1e-6),
            tspan = (0.0, 10.0),
            tstops = 0.0:0.1:10.0,
            tsave = 0.0:0.1:10.0,
            formulation = "MassMatrix",
            all_branches_dynamic = false,
            all_lines_dynamic = false,
            seed = 22,
        ),
    ),
    test_data = (
        id = "1",
        operating_points = repeat(
            [
                RandomOperatingPointXiao(
                    generator_voltage_range = (0.94, 1.06),
                    generator_power_range = (0.0, 1.0),
                    load_multiplier_range = (0.5, 1.5),
                ),
            ],
            5,
        ),
        perturbations = repeat(
            [[PSIDS.RandomLoadChange(time = 1.0, load_multiplier_range = (0.0, 2.0))]],
            4,
        ),
        params = PSIDS.GenerateDataParams(
            solver = "Rodas5",
            solver_tols = (reltol = 1e-3, abstol = 1e-6),
            tspan = (0.0, 10.0),
            tstops = 0.0:0.1:10.0,
            tsave = 0.0:0.1:10.0,
            formulation = "MassMatrix",
            all_branches_dynamic = false,
            all_lines_dynamic = false,
            seed = 33,
        ),
    ),
    model_params = SteadyStateNODEParams(
        "SteadyStateNODEParams",
        "source_1",
        1,
        "dense",
        3,
        13,
        "hardtanh",
        "dense",
        12,
        3,
        17,
        "hardtanh",
        0.0,
    ), #take from starting file. 

    #=     SteadyStateNODEParams(
            name = "source_1",
            n_ports = 1,
            initializer_layer_type = "dense",
            initializer_n_layer = 2,
            initializer_width_layers = 10,
            initializer_activation = "hardtanh",
            dynamic_layer_type = "dense",
            dynamic_hidden_states = 5,
            dynamic_n_layer = 1,
            dynamic_width_layers = 10,
            dynamic_activation = "hardtanh",
            dynamic_σ2_initialization = 0.0,
        ), =#
    steady_state_solver = (solver = "SSRootfind", abstol = 1e-4),
    dynamic_solver = (
        solver = "Rodas5",
        reltol = 1e-3,
        abstol = 1e-6,
        maxiters = 1e5,
        force_tstops = true,
    ),
    optimizer = [
        (
            sensealg = "Zygote",
            algorithm = "Bfgs",
            log_η = -2.0,
            initial_stepnorm = 0.01,
            maxiters = 100,
            lb_loss = 0.0,
            curriculum = "simultaneous",
            curriculum_timespans = [(tspan = (0.0, 10.0), batching_sample_factor = 1.0)],
            fix_params = [],
            loss_function = (α = 0.5, β = 0.5, residual_penalty = 1.0e9),
        ),
    ],
    p_start = Float32[
        0.52712405,
        0.12466063,
        0.59368306,
        -0.2512608,
        -0.36658856,
        -0.37656775,
        0.040595617,
        -0.42554918,
        0.40718147,
        0.3503858,
        -0.43710124,
        0.20499893,
        -0.31087998,
        0.6375351,
        0.20915987,
        0.50607485,
        0.37142518,
        -0.2795124,
        -0.049140584,
        -0.076601736,
        -0.027218727,
        0.53633785,
        -0.4070689,
        -0.49414986,
        -0.4712248,
        0.49804562,
        0.023099348,
        -0.087964125,
        0.30981797,
        0.2977195,
        0.59663457,
        0.3778975,
        -0.28543806,
        0.48749197,
        -0.09391466,
        -0.23869114,
        0.41207886,
        0.30127126,
        0.18161598,
        -0.043447617,
        -0.0072254157,
        0.02850331,
        0.042933766,
        -0.014394425,
        -0.03705883,
        0.029981835,
        0.034144685,
        -0.024047455,
        0.053097937,
        -0.018510148,
        -0.03835853,
        0.008066103,
        0.2121152,
        -0.4139841,
        -0.109451786,
        0.25655752,
        0.18571503,
        -0.18406916,
        0.32564083,
        -0.3810659,
        0.018553445,
        0.4326944,
        0.47365287,
        0.33294028,
        -0.41900116,
        -0.39475578,
        -0.43155968,
        0.14331394,
        0.026209632,
        0.38249704,
        0.4459977,
        -0.25104088,
        0.057676088,
        0.25933844,
        -0.38165283,
        0.42265266,
        -0.48015156,
        0.12623894,
        -0.5173165,
        0.15859434,
        0.37746564,
        -0.3690915,
        0.048746124,
        -0.39116773,
        0.4345865,
        0.058243092,
        0.23075561,
        -0.2339446,
        0.5320229,
        -0.0709576,
        0.16705045,
        -0.40317467,
        0.18076824,
        0.39565045,
        -0.08921087,
        0.16570537,
        -0.29694423,
        0.35118732,
        0.41986695,
        0.47789067,
        -0.022055656,
        0.011065145,
        -0.29666802,
        0.49197638,
        -0.038253218,
        0.3518165,
        -0.41284674,
        0.4056435,
        0.3381261,
        0.28252086,
        -0.16292426,
        -0.09375705,
        -0.28251514,
        0.112238035,
        -0.20626262,
        -0.14976713,
        -0.0636256,
        -0.16935681,
        0.26743263,
        0.23259106,
        -0.44843346,
        0.2990254,
        0.25815508,
        0.3923617,
        -0.14836636,
        -0.2239561,
        -0.2369895,
        -0.4218517,
        0.40217435,
        -0.0078570265,
        -0.18465534,
        -0.1743634,
        0.3818497,
        0.13914363,
        0.24139017,
        -0.20601344,
        0.31333265,
        0.2746093,
        0.22629866,
        0.26327503,
        0.113938905,
        -0.33780968,
        -0.15732302,
        0.06907261,
        0.14689463,
        0.05127739,
        -0.034925178,
        -0.1261577,
        0.42082763,
        0.3562929,
        0.23135553,
        0.08534519,
        -0.12725078,
        0.064059936,
        -0.12566411,
        -0.3595512,
        -0.47257617,
        -0.48529118,
        -0.4128191,
        -0.08511465,
        0.27601534,
        -0.3565128,
        -0.05995367,
        0.051102772,
        -0.057930972,
        0.1377001,
        0.3135631,
        -0.44740465,
        0.2098684,
        -0.3339799,
        0.31039697,
        0.3636719,
        -0.09061538,
        -0.17781536,
        -0.33641985,
        0.05850256,
        0.3881357,
        -0.31099272,
        -0.22209509,
        0.08284473,
        0.2655446,
        -0.38588718,
        -0.21813616,
        -0.34397116,
        -0.18499053,
        0.295924,
        0.4118155,
        -0.28367132,
        0.16059795,
        0.062416818,
        0.1629511,
        0.42542073,
        -0.14595109,
        -0.09342385,
        0.31295323,
        0.39217746,
        0.10188685,
        0.07897998,
        -0.0060433857,
        0.023633705,
        0.24521291,
        -0.14006253,
        -0.09799039,
        0.387748,
        0.23103097,
        0.3776074,
        0.08843373,
        0.30114317,
        -0.39187962,
        0.17811997,
        -0.49995467,
        -0.20982619,
        0.15915394,
        -0.21296044,
        0.08319244,
        0.44394585,
        0.45430404,
        -0.43353277,
        0.48619032,
        0.25353733,
        0.17753835,
        -0.020839818,
        0.042111356,
        0.04429894,
        0.034919046,
        -0.02626129,
        -0.012981155,
        -0.0038007956,
        0.03510903,
        0.028875612,
        -0.004899875,
        -0.015249858,
        -0.029954538,
        -0.026161896,
        0.24275257,
        0.13631505,
        0.38710055,
        0.14922924,
        -0.53921545,
        0.016191052,
        -0.040706415,
        0.2998666,
        -0.0055285017,
        0.13084193,
        -0.060559176,
        -0.44914404,
        0.30656147,
        0.15801227,
        0.37427068,
        0.4927484,
        -0.05205624,
        0.121011466,
        0.2500702,
        0.24239945,
        0.2585774,
        0.37558147,
        0.13903108,
        0.5076249,
        -0.27104,
        -0.1139743,
        0.48951834,
        -0.32498935,
        -0.3570475,
        0.25419834,
        0.3107292,
        0.19266479,
        0.2944846,
        0.18369912,
        0.3490059,
        -0.4250108,
        0.34384468,
        0.49609786,
        0.12555487,
        -0.12341187,
        -0.07487668,
        0.24807188,
        0.39758128,
        0.04990382,
        -0.09466462,
        0.24110445,
        0.33172983,
        -0.2603685,
        -0.26973438,
        0.34365508,
        0.29502857,
        0.024661591,
        -0.484902,
        0.36536682,
        0.019719813,
        -0.2769259,
        0.1912232,
        0.31244504,
        -0.52834266,
        0.10852391,
        0.10783405,
        -0.35269693,
        -0.064573064,
        0.27779886,
        -0.24556372,
        -0.4153088,
        0.28587744,
        -0.33036074,
        0.0637965,
        -0.03865537,
        -0.28596333,
        -0.20888337,
        -0.06350768,
        -0.34841546,
        0.14546475,
        0.26846904,
        -0.006911944,
        -0.080852464,
        -0.28443098,
        0.13326937,
        0.30884394,
        -0.49571773,
        0.2249458,
        0.3290706,
        0.13784815,
        -0.43109965,
        -0.45177627,
        0.4757944,
        -0.108738266,
        0.08744566,
        -0.072237715,
        0.38203907,
        0.22496022,
        -0.36925328,
        -0.09528278,
        0.17217,
        -0.3319988,
        0.19967939,
        0.32490572,
        -0.435741,
        0.2010392,
        -0.29040843,
        0.23245895,
        -0.4544116,
        -0.094138466,
        -0.2199245,
        -0.49507296,
        -0.34695894,
        0.30689427,
        0.0070277737,
        0.21255204,
        -0.19788472,
        0.26569685,
        -0.32567298,
        -0.46947247,
        0.07351084,
        0.49313062,
        -0.25896713,
        0.34801367,
        0.069211654,
        -0.31379476,
        0.13910015,
        -0.026973765,
        0.031286508,
        0.1763775,
        0.3375988,
        0.3479639,
        0.4794416,
        -0.38374823,
        0.0045975507,
        -0.1775344,
        -0.14029542,
        -0.48066536,
        0.17194314,
        0.14385837,
        -0.26116958,
        -0.13115829,
        0.13741346,
        -0.4006588,
        -0.16601437,
        -0.18031691,
        0.06936772,
        0.0075843176,
        0.29833263,
        -0.40715703,
        -0.2567498,
        0.17487074,
        -0.22425212,
        -0.21657786,
        -0.4212659,
        0.071774915,
        0.26233116,
        -0.051859315,
        -0.14241596,
        -0.26400304,
        0.115889855,
        -0.29501325,
        0.17280202,
        -0.05128535,
        -0.23062757,
        -0.26258978,
        0.46224937,
        0.121342674,
        -0.37971142,
        -0.4091155,
        -0.01301239,
        -0.20992112,
        -0.18091518,
        0.28566462,
        0.031397115,
        0.019825675,
        0.0023573523,
        0.008413662,
        0.03592758,
        -0.033313327,
        0.047742166,
        0.00012720049,
        0.0021585685,
        0.0038824107,
        0.0086081065,
        0.018069293,
        -0.008529643,
        0.17191558,
        -0.20073593,
        -0.31642357,
        -0.109765895,
        0.41069892,
        -0.2346662,
        -0.48402172,
        0.25500453,
        0.033099566,
        -0.27827784,
        0.3045149,
        0.24092239,
        0.26949894,
        -0.5139302,
        0.0857536,
        -0.42215556,
        -0.1482826,
        0.03393823,
        0.3040797,
        -0.34061092,
        -0.45276627,
        -0.24205564,
        -0.22483625,
        0.34607846,
        -0.2311257,
        0.30057114,
        0.26552445,
        0.30253294,
        -0.20021075,
        0.45363465,
        -0.2464923,
        0.26612747,
        -0.28367788,
        0.1282869,
        -0.07346688,
        -0.38170698,
        -0.11482339,
        0.36023203,
        0.3436275,
        -0.48829094,
        0.20278756,
        0.049105152,
        -0.34986907,
        0.13782097,
        -0.33002582,
        -0.37902874,
        -0.40260673,
        -0.3238059,
        -0.3647117,
        -0.2313265,
        0.042536937,
        -0.23827912,
        0.46040505,
        0.38612533,
        -0.3541382,
        0.14974573,
        -0.10490926,
        -0.21082614,
        0.3784003,
        -0.14819953,
        -0.082222015,
        0.5644561,
        -0.2772699,
        0.093230054,
        -0.24724361,
        0.057181694,
        -0.01184404,
        -0.20680493,
        -0.495974,
        -0.17539062,
        -0.1998608,
        0.5081655,
        0.40884128,
        -0.3004759,
        -0.026009958,
        0.06458467,
        -0.14869985,
        -0.39506894,
        -0.35768685,
        -0.19107187,
        0.3495983,
        -0.12792368,
        -0.10242575,
        -0.06204465,
        -0.02279309,
        -0.17456928,
        -0.27874503,
        0.088402845,
        -0.12995465,
        -0.00881681,
        0.17861319,
        0.43018347,
        0.29237556,
        0.13401917,
        0.2746889,
        -0.2503619,
        -0.30202636,
        -0.35600877,
        -0.2188846,
        -0.3686965,
        -0.080328576,
        0.058207307,
        0.4128342,
        0.0654428,
        0.32796425,
        0.40186903,
        0.014170852,
        0.13357055,
        -0.45490837,
        0.27318308,
        -0.4179391,
        0.005869964,
        -0.42827848,
        0.28887376,
        0.1295736,
        -0.1472869,
        0.11376955,
        0.28389114,
        -0.15291601,
        0.006375208,
        -0.33657116,
        0.1661354,
        -0.2682913,
        0.2154035,
        -0.4504984,
        -0.51694924,
        0.14397444,
        -0.07702999,
        0.16202228,
        -0.18835796,
        0.11819422,
        -0.106056675,
        -0.26500797,
        0.38833335,
        -0.37794185,
        -0.045045324,
        0.24153405,
        -0.17799775,
        -0.053248085,
        -0.106676914,
        -0.1626162,
        -0.15011121,
        0.21948642,
        0.3596098,
        -0.3212941,
        0.08142959,
        0.22318874,
        0.00014356615,
        -0.04966282,
        -0.39009508,
        -0.36472547,
        0.13911061,
        0.36896163,
        -0.32588404,
        0.37332538,
        0.0328982,
        0.01782864,
        0.38490218,
        -0.44027674,
        0.079686075,
        -0.25446695,
        -0.39565945,
        -0.4462779,
        0.4169368,
        -0.33323482,
        0.2706871,
        -0.09953218,
        0.13899516,
        0.037233923,
        0.14764471,
        -0.18337262,
        -0.40107805,
        0.090505145,
        0.20885669,
        -0.43434638,
        0.37222904,
        0.40311965,
        -0.41586578,
        -0.030059984,
        0.0467563,
        -0.15213184,
        -0.32155266,
        -0.022775251,
        -0.04639158,
        -0.03440753,
        0.04666412,
        -0.022361938,
        -0.050016053,
        -0.030549582,
        0.006850945,
        0.004102609,
        0.008004095,
        0.00855186,
        -0.029135289,
        -0.024172043,
        -0.051527765,
        -0.379695,
        0.2977642,
        0.15759544,
        0.22844054,
        -0.09898412,
        -0.34329307,
        -0.42551047,
        -0.08717255,
        -0.4050365,
        -0.07721241,
        0.33670768,
        -0.022279115,
        0.03794681,
        -0.22514057,
        -0.33257005,
        -0.017934123,
        0.02122238,
        -0.35031882,
        0.3488778,
        0.22624584,
        0.05791133,
        0.37292644,
        -0.41106352,
        0.22046615,
        0.37959245,
        -0.20232393,
        0.27772316,
        -0.04824826,
        0.3646626,
        0.24245447,
        -0.14495249,
        -0.13486356,
        -0.05445515,
        -0.08052952,
        0.18098152,
        0.28318936,
        -0.29354098,
        -0.43238786,
        0.008236984,
        -0.21613143,
        0.16119403,
        -0.022593515,
        -0.17103961,
        0.41755128,
        0.0035793646,
        0.22782572,
        -0.41136274,
        0.37179118,
        -0.13742864,
        0.31848654,
        -0.05545302,
        -0.09213459,
        0.35886696,
        -0.09360272,
        0.08562549,
        0.114414476,
        -0.39317805,
        -0.33783484,
        0.082262084,
        0.09373495,
        -0.052951872,
        -0.3528294,
        0.12389347,
        0.38960123,
        -0.38152504,
        -0.36983958,
        0.25216013,
        -0.09715429,
        0.028344389,
        0.2487252,
        -0.124072455,
        0.34379536,
        -0.4046085,
        0.075658284,
        0.07003006,
        0.21773812,
        -0.16249068,
        -0.15397072,
        -0.4226642,
        -0.11354548,
        -0.26900703,
        -0.15979013,
        -0.27719638,
        -0.40702918,
        -0.076492675,
        0.33985937,
        -0.37568906,
        0.34311137,
        -0.13362657,
        -0.17522132,
        -0.10792852,
        -0.15527163,
        0.3305085,
        0.4565925,
        0.03908406,
        -0.0641449,
        -0.25569692,
        0.022191297,
        0.34548306,
        -0.39226583,
        -0.014359377,
        -0.2565131,
        -0.37752187,
        0.18575929,
        -0.26766163,
        -0.29987335,
        -0.09535892,
        -0.12697764,
        0.23760678,
        -0.22651733,
        -0.14309804,
        -0.24346143,
        0.14161998,
        -0.40508813,
        0.4300034,
        0.29597336,
        0.054360397,
        -0.15262127,
        -0.06698287,
        -0.3924961,
        -0.14281297,
        0.031009613,
        -0.09799962,
        -0.06955836,
        0.18523535,
        -0.23740311,
        -0.396007,
        0.40965545,
        0.33896944,
        0.11516286,
        0.22851504,
        0.033601508,
        0.32367378,
        -0.1182003,
        -0.19051223,
        -0.29992557,
        0.23112176,
        0.3479287,
        0.27145907,
        -0.21271499,
        -0.25301957,
        -0.38571414,
        0.048716012,
        -0.11069916,
        0.39409932,
        0.40162024,
        -0.2907366,
        0.22444838,
        0.016569737,
        -0.28889835,
        -0.34881693,
        -0.21424362,
        -0.012805037,
        0.17566857,
        0.006533129,
        0.10377188,
        0.31487355,
        0.1497699,
        0.42147082,
        -0.26014334,
        0.058925286,
        0.027022626,
        -0.17988454,
        -0.40048677,
        -0.23913598,
        0.01258259,
        -0.36683863,
        0.29062453,
        -0.08153132,
        -0.39699402,
        0.100783914,
        -0.16697522,
        0.31613672,
        -0.23514517,
        0.106452934,
        -0.369089,
        0.16401105,
        0.31455588,
        0.10084968,
        0.4409829,
        0.23157811,
        -0.3820483,
        0.040547173,
        -0.41077036,
        -0.1958058,
        0.3609894,
        -0.13546307,
        0.31241196,
        -0.0013045953,
        0.20839758,
        -0.40536198,
        0.20604213,
        -0.210996,
        -0.26520613,
        0.17445368,
        -0.4136846,
        -0.29907873,
        0.16208792,
        -0.25801915,
        -0.22999573,
        -0.1154669,
        0.015630672,
        -0.33452922,
        0.33038068,
        -0.31701925,
        -0.27045047,
        -0.40739402,
        -0.12918846,
        0.00042731065,
        -0.19468279,
        0.40208337,
        -0.4291046,
        -0.23825298,
        -0.08557096,
        0.090513214,
        -0.41691372,
        0.047076553,
        0.17558552,
        0.38338977,
        0.18608326,
        -0.086590156,
        -0.08382909,
        0.10108121,
        0.2580397,
        -0.21111171,
        -0.031934373,
        0.36718655,
        0.041206907,
        0.22418697,
        -0.24786575,
        -0.29824713,
        -0.10082971,
        -0.3688219,
        0.30733377,
        -0.017912293,
        -0.38585523,
        0.13957548,
        -0.2103721,
        -0.2324803,
        0.07110313,
        0.28205687,
        0.0052320864,
        -0.13826263,
        -0.24634933,
        -0.21696252,
        -0.16961801,
        0.38121822,
        -0.12321028,
        -0.050457302,
        -0.3636517,
        -0.36276487,
        0.02119688,
        -0.3599476,
        -0.105920576,
        -0.34178835,
        0.08246106,
        -0.40617937,
        0.08515779,
        -0.26633385,
        0.0625783,
        0.18724737,
        0.14385921,
        -0.35882616,
        0.42299232,
        -0.34855378,
        -0.30580464,
        0.08598506,
        0.04833126,
        -0.012577984,
        0.19303285,
        -0.24858566,
        0.09155827,
        -0.012531003,
        0.002568683,
        0.004312064,
        0.005324798,
        0.013471829,
        -0.006364389,
        0.009812224,
        -0.0057345927,
        0.0068847467,
        -0.0075319624,
        -0.0016360079,
        0.00046359995,
        -0.004925723,
        0.0003866313,
        -0.004570419,
        0.004177467,
        0.008258143,
        0.2528327,
        0.26795596,
        0.36765778,
        0.3448263,
        0.38662982,
        -0.16263102,
        0.10630518,
        0.12028768,
        0.2859336,
        -0.32029423,
        -0.11985711,
        -0.13260885,
        -0.4199116,
        0.38151285,
        -0.35680416,
        0.17598134,
        0.30935785,
        -0.25200546,
        0.042927124,
        -0.3179381,
        -0.073520005,
        -0.17544538,
        -0.36968833,
        0.17264022,
        0.26674035,
        -0.19434471,
        -0.37185547,
        0.3447746,
        -0.1823007,
        -0.1343357,
        0.15570055,
        -0.14978288,
        -0.1676919,
        -0.08257646,
        -0.2496076,
        -0.118274935,
        -0.392591,
        -0.43268484,
        0.3955491,
        0.24774031,
        0.07286969,
        -0.21398361,
        0.34191203,
        -0.030711254,
        0.08931453,
        -0.030696876,
        -0.14615133,
        0.09927076,
        -0.14881645,
        0.12720032,
        -0.14072256,
        -0.0776866,
        -0.24095422,
        -0.1972502,
        -0.40322733,
        -0.10611417,
        -0.28163186,
        0.2673478,
        -0.42293334,
        -0.1188129,
        0.32942033,
        -0.36169124,
        0.3903684,
        -0.13402529,
        -0.18263386,
        0.19187297,
        0.35323074,
        0.22890705,
        -0.41552973,
        -0.29783377,
        0.22926773,
        -0.36458692,
        0.11269286,
        0.12906216,
        0.30503055,
        -0.10809763,
        -0.23563312,
        0.13669106,
        -0.033394385,
        -0.39925736,
        0.36549598,
        -0.3258502,
        0.14193131,
        -0.42802012,
        -0.38050082,
        0.29835293,
        0.18524863,
        0.041735765,
        0.1516274,
        -0.120659746,
        -0.0053110793,
        -0.2604588,
        0.35056865,
        0.21321717,
        0.10078732,
        -0.19729331,
        -0.040182997,
        -0.13544,
        -0.20112333,
        0.3555595,
        -0.2729409,
        0.34757736,
        -0.1052181,
        -0.05344661,
        -0.2589707,
        0.41239446,
        0.016719567,
        0.04369571,
        -0.3335078,
        -0.08541559,
        0.28952855,
        -0.105496734,
        0.4022155,
        0.053368915,
        -0.032984465,
        -0.3967542,
        0.2622293,
        0.27850237,
        -0.30146804,
        0.19888312,
        0.33352408,
        -0.3620949,
        -0.082283705,
        0.40037644,
        -0.382201,
        -0.18955469,
        0.2873056,
        0.28524324,
        -0.15501295,
        -0.059106883,
        0.22102627,
        0.33348542,
        -0.07682389,
        0.4210827,
        0.35662022,
        0.036024343,
        0.22286667,
        -0.23726,
        -0.22994334,
        -0.017507717,
        -0.049430247,
        0.065398514,
        -0.40477815,
        0.0030811832,
        -0.043667607,
        -0.13886982,
        0.22297467,
        -0.3044389,
        -0.3836285,
        -0.36542448,
        0.2637039,
        0.35116813,
        -0.09837965,
        -0.090731576,
        0.006251107,
        -0.090534866,
        -0.39522517,
        0.27003112,
        -0.1459928,
        0.23147616,
        -0.4158271,
        -0.20981082,
        -0.3715779,
        0.27731124,
        0.31740147,
        0.2739002,
        0.35089058,
        0.10369277,
        -0.27676487,
        0.2743799,
        0.32526657,
        -0.051398102,
        0.015278375,
        0.030410811,
        0.26971754,
        0.19745535,
        0.39863837,
        0.11214892,
        0.32331276,
        0.3770691,
        0.013455339,
        0.32608446,
        -0.014094278,
        0.10337674,
        0.40908062,
        -0.327561,
        0.06946905,
        0.016695365,
        0.28654093,
        0.23247774,
        0.24474272,
        -0.16103469,
        0.030313868,
        0.17826311,
        -0.22642133,
        0.054700546,
        0.2739684,
        0.22846738,
        0.31794354,
        0.20595051,
        -0.2871711,
        0.38545573,
        -0.32250366,
        -0.06555726,
        -0.11821209,
        0.18477544,
        0.124431975,
        0.38527864,
        -0.3698812,
        -0.3254868,
        0.04727583,
        -0.28189194,
        -0.0022286042,
        0.22213311,
        0.10869223,
        -0.3745608,
        0.1479242,
        0.3442784,
        0.09982735,
        0.051387385,
        0.16016328,
        0.21547045,
        -0.20589198,
        -0.35266498,
        -0.29010946,
        -0.1403756,
        -0.3465926,
        0.109296344,
        0.068662934,
        0.008074725,
        0.29675472,
        0.12721674,
        -0.32187778,
        0.21618518,
        0.0005064895,
        0.21231481,
        -0.38194543,
        0.29368332,
        -0.38465697,
        -0.1131474,
        0.34052864,
        0.035310395,
        0.04043369,
        -0.10528249,
        -0.17501374,
        0.35384244,
        0.06336001,
        0.34184545,
        0.21331371,
        -0.14904495,
        -0.29652473,
        0.37602815,
        -0.032627873,
        -0.32452616,
        0.29296255,
        -0.24265638,
        0.06301522,
        0.14063595,
        -0.059997123,
        -0.3928186,
        -0.35950482,
        0.13136153,
        -0.104563676,
        0.2892072,
        0.12592344,
        0.052801125,
        -0.24725306,
        0.40912986,
        -0.017597716,
        -0.3784128,
        0.20017926,
        -0.24263003,
        0.13524017,
        0.35491705,
        0.39833498,
        0.06103725,
        0.007307331,
        0.13681072,
        0.19164144,
        0.09536951,
        0.011958844,
        0.08131205,
        0.2965849,
        -0.040598825,
        0.028415442,
        -0.3649942,
        -0.14337532,
        -0.32715732,
        -0.21458808,
        -0.008095991,
        -0.001401309,
        -0.001668978,
        -0.0048844605,
        -0.0022525308,
        0.0057468326,
        0.0031371736,
        -0.00027247658,
        0.0016157259,
        0.001343326,
        -0.000525576,
        -0.0051193084,
        -0.0062898328,
        -0.0062043793,
        -0.0012423802,
        0.0037576102,
        -0.0022726706,
        -0.13033795,
        -0.38731065,
        0.054734025,
        -0.38283953,
        0.20789784,
        0.28711596,
        -0.03464082,
        -0.0993379,
        -0.06285714,
        0.16946071,
        -0.09024193,
        0.12848538,
        0.2546587,
        0.24841663,
        -0.116102,
        0.15105073,
        -0.071303055,
        -0.2988669,
        0.40981635,
        -0.29685584,
        -0.1372641,
        -0.0006813967,
        0.15174234,
        -0.38916564,
        -0.34082994,
        -0.3016352,
        -0.3556969,
        0.25866827,
        0.2471639,
        -0.19776328,
        -0.228728,
        -0.3617836,
        -0.24736327,
        0.2528522,
        0.19439414,
        0.30062747,
        0.15231778,
        -0.19118346,
        0.15406586,
        0.31916162,
        0.006229366,
        -0.19094157,
        -0.312242,
        -0.38934365,
        -0.40708312,
        0.27466166,
        0.24771303,
        0.2084901,
        -0.23350821,
        -0.21908766,
        -0.17607725,
        -0.34240484,
        0.39517617,
        -0.25290275,
        -0.38502344,
        -0.067811884,
        0.14528067,
        0.31332046,
        -0.34791166,
        -0.36315405,
        0.029197479,
        0.24154837,
        -0.14953934,
        0.1947543,
        -0.0010686142,
        -0.14724833,
        0.32453415,
        -0.08971557,
        0.22467026,
        -0.24669705,
        0.3189966,
        -0.37391004,
        -0.3770641,
        0.077781424,
        -0.012398576,
        -0.3249584,
        0.13849932,
        -0.025342327,
        -0.037517715,
        0.40798414,
        0.28265482,
        -0.21091437,
        -0.24245961,
        0.15045048,
        -0.3752927,
        -0.26575336,
        0.28784743,
        0.27189308,
        -0.3397014,
        -0.2684196,
        -0.24322921,
        -0.35830384,
        0.056689315,
        -0.08392018,
        -0.34372923,
        -0.30880424,
        0.0933287,
        0.26041433,
        0.3647933,
        -0.11941677,
        0.35155803,
        -0.0459946,
        0.29831636,
        0.016189732,
        0.40824983,
        -0.25274292,
        0.37463704,
        0.05842561,
        0.3838841,
        -0.17350872,
        -0.08218027,
        -0.028685708,
        0.11200397,
        -0.1847509,
        -0.16490857,
        -0.17649853,
        -0.3786785,
        0.1672938,
        -0.018960077,
        -0.2921114,
        -0.026021348,
        -0.23581457,
        0.3663586,
        0.3691103,
        -0.008128801,
        -0.14417574,
        0.220128,
        -0.35032314,
        -0.08986953,
        -0.086169966,
        0.07547224,
        -0.32442153,
        0.29873148,
        0.067160435,
        -0.18142945,
        0.11165074,
        0.4265574,
        0.2906518,
        -0.18214862,
        0.30247426,
        0.099283725,
        -0.36975497,
        0.37640324,
        -0.17040844,
        0.3678071,
        0.17623237,
        -0.08043253,
        -0.32914305,
        0.17897159,
        0.23939374,
        -0.363974,
        0.20940235,
        -0.33329841,
        0.072115414,
        -0.06659175,
        -0.30068853,
        0.16469656,
        0.20860493,
        -0.35868987,
        -0.15945482,
        0.3478065,
        0.16140683,
        -0.39933655,
        0.34826267,
        -0.21818474,
        0.15447263,
        -0.08262361,
        0.23909682,
        0.021830468,
        -0.27158713,
        -0.38388145,
        0.013982944,
        -0.26905966,
        0.08605862,
        0.2988598,
        -0.06518601,
        0.07682507,
        -0.30369806,
        0.028551804,
        0.293866,
        0.37393197,
        0.08605347,
        -0.26348343,
        -0.16939582,
        0.26192012,
        -0.2264816,
        -0.120369345,
        0.31073406,
        0.31229788,
        -0.32428086,
        -0.35867062,
        0.27475363,
        0.17855734,
        -0.036531255,
        -0.11239929,
        0.2740681,
        0.34174827,
        -0.19214255,
        -0.3001116,
        -0.40595627,
        -0.31156453,
        0.35380653,
        0.16468912,
        0.3297132,
        -0.28821912,
        0.05997197,
        -0.25619575,
        0.031798806,
        -0.3568783,
        -0.17878212,
        -0.20670831,
        0.408715,
        0.011196328,
        -0.14738606,
        -0.29857475,
        0.4057883,
        -0.045567706,
        -0.2448063,
        0.14140564,
        -0.26976117,
        -0.029485032,
        -0.2616166,
        -0.3089409,
        -0.33523414,
        -0.2541535,
        0.02010079,
        -0.30892643,
        -0.26680648,
        0.4034271,
        -0.33188546,
        0.39372626,
        0.04864602,
        0.26112136,
        0.12576666,
        0.3902272,
        0.31519645,
        0.10025514,
        0.09366053,
        0.34584102,
        0.39148036,
        0.07601285,
        0.012865896,
        0.089659736,
        -0.2456356,
        -0.36594084,
        0.059001062,
        -0.106303856,
        0.25987026,
        0.12792434,
        -0.17879596,
        -0.27481458,
        -0.21112421,
        0.18343057,
        -0.23954155,
        0.06172755,
        0.418694,
        -0.23887385,
        -0.2748649,
        -0.3208622,
        0.10325077,
        -0.38236713,
        -0.3179452,
        -0.04558757,
        -0.33748573,
        0.036647033,
        -0.13382834,
        0.2802659,
        0.008162781,
        0.13423161,
        0.3308676,
        0.1873864,
        -0.4113756,
        0.19666749,
        0.0110447835,
        0.2505687,
        0.3754842,
        -0.32375818,
        0.3609838,
        0.32120922,
        -0.09572334,
        0.3598543,
        0.17715797,
        -0.30950692,
        -0.36296847,
        0.12658411,
        0.20293519,
        0.031486895,
        0.31174728,
        -0.38092032,
        -0.0012876871,
        -0.0053449012,
        0.004317297,
        -0.0045036804,
        -0.0026288591,
        -0.004514107,
        0.0041997037,
        -0.006610116,
        0.0013865464,
        -0.0085972315,
        -0.000648938,
        -0.008796657,
        -0.0049656583,
        0.0022883262,
        0.0030367728,
        -0.0010092432,
        0.0028356544,
        -0.06412569,
        -0.37265176,
        -0.02892312,
        0.30952123,
        0.22018132,
        -0.16352536,
        -0.2919965,
        -0.067584015,
        -0.08660406,
        -0.30423617,
        -0.25163266,
        -0.08775047,
        -0.12213676,
        0.38184932,
        -0.061235916,
        0.381528,
        -0.051488362,
        0.24018183,
        -0.39492768,
        0.35153174,
        -0.39814514,
        -0.17980194,
        -0.040575065,
        -0.31171986,
        0.37595838,
        0.046019442,
        -0.029572472,
        -0.08719678,
        -0.3564139,
        0.013890961,
        -0.07065847,
        -0.08907807,
        0.3885788,
        0.15787171,
        -0.15282235,
        -0.056703508,
        0.3280458,
        -0.20731236,
        0.047753204,
        -0.33111104,
        0.22314678,
        0.16498561,
        -0.08868302,
        0.42180887,
        -0.10315867,
        -0.15000048,
        -0.28784108,
        0.021310585,
        0.22996163,
        0.33845496,
        -0.13812336,
        -0.30279478,
        -0.07350327,
        0.14814854,
        0.11112019,
        0.46270695,
        -0.23400341,
        -0.16070633,
        -0.1507645,
        -0.27544168,
        0.09518651,
        0.25093064,
        -0.29395035,
        -0.25791052,
        0.37339923,
        0.14839451,
        0.28037497,
        -0.2623171,
        0.322787,
        0.3541375,
        -0.10918741,
        -0.27631027,
        0.06823011,
        -0.41956487,
        -0.20427012,
        0.14987317,
        -0.15946478,
        -0.029824832,
        -0.28485087,
        0.24486159,
        -0.0070029176,
        0.3818731,
        -0.17433822,
        0.3675334,
        -0.31572458,
        -0.24292776,
        0.1615932,
        -0.43981487,
        0.029584711,
        0.19073945,
        -0.31393898,
        -0.28596494,
        0.22454484,
        -0.22652958,
        0.38704807,
        0.37344232,
        -0.30961877,
        -0.23853812,
        0.4084713,
        0.2108133,
        0.074760534,
        0.3397454,
        0.1102979,
        -0.41635647,
        0.19014278,
        0.06442812,
        -0.2290747,
        0.03378971,
        -0.26926365,
        0.056752715,
        -0.43308485,
        0.38971293,
        -0.43411934,
        0.077653274,
        0.37264222,
        0.22724521,
        0.18715027,
        -0.096637346,
        -0.13906385,
        0.37232998,
        -0.09016886,
        0.2693317,
        0.13478534,
        0.42714855,
        0.03307548,
        -0.3276053,
        -0.0755747,
        0.023922028,
        -0.067578204,
        -0.3467975,
        0.2705349,
        -0.13970406,
        -0.07864764,
        -0.15864544,
        -0.42194852,
        -0.17366336,
        -0.16119534,
        0.28021416,
        -0.24133356,
        -0.0067834794,
        -0.13204488,
        -0.2547801,
        -0.3701,
        -0.21007104,
        -0.24328762,
        0.088324785,
        -0.11916224,
        -0.2597853,
        0.049013723,
        0.3315048,
        0.2007002,
        -0.3327286,
        0.26266104,
        -0.079349406,
        -0.097843274,
        -0.2399173,
        -0.34322414,
        0.40620673,
        0.17091037,
        0.09927039,
        0.15387803,
        -0.4561354,
        -0.2625841,
        -0.2781015,
        0.42559135,
        0.12450131,
        -0.14931266,
        0.41910884,
        -0.4257426,
        0.30263066,
        0.29613778,
        -0.45351315,
        0.25174555,
        0.39537513,
        -0.42301556,
        -0.29589817,
        0.07040274,
        0.4146722,
        0.14186513,
        0.0555506,
        0.16963033,
        0.296144,
        -0.039466716,
        0.1300536,
        -0.07979383,
        0.22272247,
        0.44253317,
        -0.41182002,
        -0.40294787,
        0.327214,
        0.39331445,
        0.35406974,
        0.084013276,
        0.16787608,
        -0.43449447,
        -0.02854451,
        -0.023551172,
        -0.24029787,
        -0.26019746,
        0.48064753,
        -0.22060196,
        0.19273078,
        0.3161499,
        -0.032671846,
        -0.0010422295,
        -0.010952745,
        0.006000031,
        -0.0027638013,
        -0.004574973,
        -0.010494316,
        -0.0038837325,
        -0.003709631,
        -0.003010632,
        0.0068632076,
        -0.0046255356,
        -0.0032687052,
    ], #take from starting file. 
    check_validation_loss_iterations = [], #collect(2000:50:4000),
    validation_loss_termination = "false",
    rng_seed = 1,
    output_mode_skip = 1,
    train_time_limit_seconds = 1e9,
    base_path = joinpath(SCRATCH_PATH, project_folder, train_folder),
    system_path = joinpath(
        SCRATCH_PATH,
        project_folder,
        train_folder,
        PowerSimulationNODE.INPUT_SYSTEM_FOLDER_NAME,
        string(system_name, ".json"),
    ),
)

g = (:initial_stepnorm, (0.0, 0.001, 0.01, 0.1))
params_data = build_grid_search!(base_option, g)
##
#=
 hpc_params = SavioHPCTrain(;
    username = "jdlara",
    params_data = params_data,
    project_folder = "PowerSystemNODEs",
    scratch_path = "/global/home/users/jdlara",
)
  =#
hpc_params = AlpineHPCTrain(;
    username = "mabo4366",
    params_data = params_data,
    project_folder = project_folder,
    train_folder = train_folder,
    scratch_path = SCRATCH_PATH,
    time_limit_train = "23:59:59",             #Options: ["00:30:00", "23:59:59"]
    time_limit_generate_data = "02:00:00",
    QoS = "normal",
    partition = "amilan",
    train_folder_for_data = "data_xiao_loadstep_100_20_20",
    mb_per_cpu = 9600,  #Avoide OOM error on HPC 
)
generate_train_files(hpc_params)
##                                   
run_parallel_train(hpc_params)
